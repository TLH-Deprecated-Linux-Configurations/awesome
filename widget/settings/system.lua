--  _______               __
-- |     __|.--.--.-----.|  |_.-----.--------.
-- |__     ||  |  |__ --||   _|  -__|        |
-- |_______||___  |_____||____|_____|__|__|__|
--          |_____|
-- ########################################################################
-- ########################################################################
-- ########################################################################
--
local awful = require("awful")
local wibox = require("wibox")
local gears = require("gears")
local beautiful = require("beautiful")
local icons = require("theme.icons")
local file = require("module.functions.file")
local signals = require("module.settings.signals")
local card = require("module.interface.card")

local dpi = beautiful.xresources.apply_dpi
-- ########################################################################
-- ########################################################################
-- ########################################################################
local m = dpi(10)
local settings_index = dpi(40)
local settings_width = dpi(beautiful.modal_width)
local settings_nw = dpi(260)
-- ########################################################################
-- ########################################################################
-- ########################################################################
return function()
  local view = wibox.container.margin()
  view.left = m
  view.right = m
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local title = wibox.widget.textbox(("System"))
  title.font = beautiful.font .. ' 22'
  title.forced_height = settings_index + m + m
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################

  local close = wibox.widget.imagebox(icons.close)
  close.font = beautiful.font .. ' 08'
  close.forced_height = 40
  close:buttons(
    gears.table.join(
      awful.button(
        {},
        1,
        function()
          if root.elements.hub then
            root.elements.hub.close()
          end
        end
      )
    )
  )
  --- ###################################################################
  -- ########################################################################
  -- ########################################################################
  local graph = card()
  graph.forced_height = 300
  graph.forced_width = settings_width - settings_nw - (m * 2)
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local scale = wibox.layout.align.vertical()
  local scale_max = wibox.widget.textbox("100%")
  local scale_min = wibox.widget.textbox("0%")
  scale_max.font = beautiful.font .. ' 08'
  scale_min.font = beautiful.font .. ' 08'
  scale.first = scale_max
  scale.third = scale_min
  scale.second = wibox.widget.base.empty_widget()
  scale.forced_width = 50
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local ram_progress = wibox.widget.progressbar()
  ram_progress.max_value = 100
  ram_progress.background_color = beautiful.bg_modal .. "00"
  ram_progress.color = beautiful.xcolor6
  ram_progress.value = 0
  ram_progress.bar_shape = function(c, w, h)
    gears.shape.partially_rounded_rect(c, w, h, false, true, true, false, dpi(10))
  end
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local cpu_progress = wibox.widget.progressbar()
  cpu_progress.max_value = 100
  cpu_progress.background_color = beautiful.bg_modal .. "00"
  cpu_progress.color = beautiful.xcolor1
  cpu_progress.value = 0
  cpu_progress.bar_shape = function(c, w, h)
    gears.shape.partially_rounded_rect(c, w, h, false, true, true, false, dpi(10))
  end
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local disk_progress = wibox.widget.progressbar()
  disk_progress.max_value = 100
  disk_progress.background_color = beautiful.bg_modal .. "00"
  disk_progress.color = beautiful.xcolor4
  disk_progress.value = 0
  disk_progress.bar_shape = function(c, w, h)
    gears.shape.partially_rounded_rect(c, w, h, false, true, true, false, dpi(10))
  end
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local ram = wibox.container.rotate(ram_progress, "east")
  local cpu = wibox.container.rotate(cpu_progress, "east")
  local disk = wibox.container.rotate(disk_progress, "east")
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local ram_value = wibox.widget.textbox()
  ram_value.font = beautiful.font .. ' 08'
  ram_value.visible = false
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local cpu_value = wibox.widget.textbox()
  cpu_value.font = beautiful.font .. ' 08'
  cpu_value.visible = false

  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local disk_value = wibox.widget.textbox()
  disk_value.font = beautiful.font .. ' 08'
  disk_value.visible = false
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local ram_key = wibox.widget.textbox("RAM")
  ram_key.font = beautiful.font .. ' 08'
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local cpu_key = wibox.widget.textbox("CPU")
  cpu_key.font = beautiful.font .. ' 08'
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local disk_key = wibox.widget.textbox("Disk")
  disk_key.font = beautiful.font .. ' 08'
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  ram:connect_signal(
    "mouse::enter",
    function()
      ram_value.visible = true
    end
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  ram:connect_signal(
    "mouse::leave",
    function()
      ram_value.visible = false
    end
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  cpu:connect_signal(
    "mouse::enter",
    function()
      cpu_value.visible = true
    end
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  cpu:connect_signal(
    "mouse::leave",
    function()
      cpu_value.visible = false
    end
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  disk:connect_signal(
    "mouse::enter",
    function()
      disk_value.visible = true
    end
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  disk:connect_signal(
    "mouse::leave",
    function()
      disk_value.visible = false
    end
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  graph.update_body(
    wibox.widget {
      layout = wibox.layout.align.vertical,
      {
        layout = wibox.container.margin,
        top = m,
        wibox.widget.base.empty_widget()
      },
      -- ########################################################################
      -- ########################################################################
      -- ########################################################################
      {
        layout = wibox.layout.align.horizontal,
        {
          layout = wibox.container.margin,
          margins = m,
          scale
        },
        -- ########################################################################
        -- ########################################################################
        -- ########################################################################
        {
          layout = wibox.container.margin,
          right = m * 5,
          {
            layout = wibox.container.background,
            {
              layout = wibox.layout.flex.horizontal,
              spacing = m * 1,
              {
                layout = wibox.layout.stack,
                ram,
                {layout = wibox.container.place, valign = "bottom", ram_value}
              },
              {
                layout = wibox.layout.stack,
                cpu,
                {layout = wibox.container.place, valign = "bottom", cpu_value}
              },
              {
                layout = wibox.layout.stack,
                disk,
                {layout = wibox.container.place, valign = "bottom", disk_value}
              }
            }
          }
        }
      },
      -- ########################################################################
      -- ########################################################################
      -- ########################################################################
      {
        layout = wibox.container.margin,
        left = m * 5,
        right = m * 5,
        {
          layout = wibox.layout.flex.horizontal,
          forced_height = settings_index,
          spacing = m * 2,
          {layout = wibox.container.place, ram_key},
          {layout = wibox.container.place, cpu_key},
          {layout = wibox.container.place, disk_key}
        }
      }
    }
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local pac = card()
  pac:buttons(
    gears.table.join(
      awful.button(
        {},
        1,
        function()
          local term = os.getenv("TERMINAL") or "kitty"
          awful.spawn(term .. ' -e "system-updater"')
        end
      )
    )
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local pac_icon = wibox.container.margin(wibox.widget.imagebox(icons.package), dpi(12), dpi(12), dpi(12), dpi(12))
  pac_icon.forced_height = settings_index + m + m
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local pac_title = wibox.widget.textbox("System Updates")
  pac_title.font = beautiful.title_font
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local pac_value = wibox.widget.textbox("None available")
  pac_value.font = beautiful.title_font
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  pac.update_body(
    wibox.widget {
      layout = wibox.layout.align.horizontal,
      {layout = wibox.container.margin, left = m, pac_icon},
      {layout = wibox.container.margin, left = m, pac_title},
      {layout = wibox.container.margin, right = m, pac_value}
    }
  )

  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local general_info = card()
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local osName =
    wibox.widget {
    font = beautiful.title_font,
    text = "OS: unknown",
    widget = wibox.widget.textbox
  }
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local kernelVersion =
    wibox.widget {
    font = beautiful.title_font,
    text = "Kernel: unknown",
    widget = wibox.widget.textbox
  }
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local hostName =
    wibox.widget {
    font = beautiful.title_font,
    text = ("Hostname: ") .. file.string("/etc/hostname"):gsub("%\n", ""),
    widget = wibox.widget.textbox
  }
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local uptime =
    wibox.widget {
    font = beautiful.title_font,
    text = ("Uptime: unknown"),
    widget = wibox.widget.textbox
  }
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local proc_value = wibox.widget.textbox()
  proc_value.font = "agave Nerd Font Mono Bold 17"
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local proc =
    wibox.widget {
    forced_height = dpi(300),
    bg = beautiful.bg_modal,
    shape = function(cr, rect_width, rect_height)
      gears.shape.partially_rounded_rect(cr, rect_width, rect_height, true, true, true, true, 12)
    end,
    widget = wibox.container.background,
    proc_value,
    align = "center",
    valign = "center"
  }
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  local proccmd = 'bash -c "ps -eo comm:45,%mem,%cpu --sort=-%cpu,-%mem | head -n 12"'
  awful.widget.watch(
    proccmd,
    5,
    function(w, o)
      proc_value.text = o:gsub("^%s*(.-)%s*$", "%1")
    end
  )

  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  signals.connect_distro(
    function(value)
      osName.text = ("OS: ") .. value
    end
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  signals.connect_uptime(
    function(value)
      uptime.text = ("Uptime: ") .. value
    end
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  signals.connect_kernel(
    function(value)
      kernelVersion.text = ("Kernel: ") .. value
    end
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  general_info.update_body(
    wibox.widget {
      layout = wibox.layout.fixed.vertical,
      wibox.container.margin(osName, dpi(20), 0, dpi(20), 0),
      wibox.container.margin(kernelVersion, dpi(20)),
      wibox.container.margin(hostName, dpi(20)),
      wibox.container.margin(uptime, dpi(20), 0, 0, dpi(20))
    }
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  view:setup {
    layout = wibox.container.background,
    {
      layout = wibox.layout.fixed.vertical,
      {
        layout = wibox.layout.align.horizontal,
        nil,
        wibox.container.margin(
          {
            layout = wibox.container.place,
            title
          },
          settings_index * 2
        ),
        close
      },
      graph,
      {layout = wibox.container.margin, top = m, pac},
      {layout = wibox.container.margin, top = m, bottom = m, general_info},
      {layout = wibox.container.margin, top = m, bottom = m, proc}
    }
  }
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  signals.connect_ram_usage(
    function(value)
      ram_progress:set_value(value)
      ram_value.text = value .. "%"
    end
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  signals.connect_packages_to_update(
    function(value)
      pac_value.text = ("Packages to update: ") .. value
    end
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  signals.connect_cpu_usage(
    function(value)
      cpu_progress:set_value(value)
      cpu_value.text = value .. "%"
    end
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  signals.connect_disk_usage(
    function(value)
      disk_progress:set_value(value)
      disk_value.text = value .. "%"
    end
  )
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  view.refresh = function()
  end
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  view.refresh()
  -- ########################################################################
  -- ########################################################################
  -- ########################################################################
  return view
end
